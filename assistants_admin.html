<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ø§Ù„Ø³ÙŠØ§Ø­ÙŠÙŠÙ†</title>
<style>
:root {
  --dark-bg:#121212; --card-bg:#1f1f1f; --gold:#ffc107; --blue-royal:#4a6fa5;
  --white:#e0e0e0; --red-emergency:#cf6679; --green-success:#4caf50; --text-color:#e0e0e0;
}
body{background-color:var(--dark-bg); color:var(--text-color); font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0;}
.header-controls{display:flex; justify-content:flex-end; padding:15px; background-color:#1f1f1f; border-bottom:1px solid #333;}
.btn-back{background-color:var(--blue-royal); color:#fff; padding:8px 15px; border-radius:6px; text-decoration:none; font-size:0.9em; cursor:pointer; margin-left:10px;}
.btn-back:hover{background-color:#3b5b82;}
.container{ max-width:1000px; margin:20px auto; position:relative; }
.role-select{ margin-bottom:20px; padding:10px; border-radius:6px; border:1px solid var(--blue-royal); background-color:#2a2a2a; color:#fff; }
.filter-input{ width:100%; padding:12px; margin-bottom:20px; border-radius:6px; border:1px solid var(--blue-royal); background-color:#2a2a2a; color:var(--white); font-size:1em; }
.cards-grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(300px,1fr)); gap:25px; }
.assistant-card{ background-color:#2a2a2a; border-radius:10px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.4); border:1px solid var(--blue-royal); position:relative; transition:transform 0.3s,border-color 0.3s; }
.assistant-card:hover{ transform:translateY(-5px); border-color:var(--gold); }
.card-header{ display:flex; align-items:center; margin-bottom:15px; border-bottom:1px dashed #444; padding-bottom:10px; }
.profile-img{ width:70px; height:70px; border-radius:50%; object-fit:cover; border:2px solid var(--gold); margin-left:15px; }
.card-header h3{ color:var(--gold); margin:0; font-size:1.4em; }
.card-details p{ margin:8px 0; text-align:right; font-size:0.95em; color:#ccc; }
.card-details strong{ color:var(--white); }
.rating{ color: var(--text-color); font-size:1.1em; margin-top:5px; }
.btn-delete{ margin-top:10px; padding:10px 16px; border:none; border-radius:6px; background-color:var(--red-emergency); color:#fff; cursor:pointer; font-size:1.1em; width:48%; display:inline-block; }
.btn-comments { background-color:var(--green-success); margin-left:4%; }
.notification-box { position:absolute; top:0; left:50%; transform:translateX(-50%); background-color:var(--green-success); color:#fff; padding:8px 12px; border-radius:6px; margin-top:10px; display:none; z-index:2000; }
</style>
</head>

<body>
<div class="header-controls">
  <a href="manager_dashboard.html" class="btn-back">ğŸ”™ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
</div>

<div class="container">
  <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ø§Ù„Ø³ÙŠØ§Ø­ÙŠÙŠÙ†</h1>
  <div id="notificationBox" class="notification-box"></div>

  <select id="roleSelect" class="role-select">
    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† --</option>
    <option value="GUIDE">Ù…Ø±Ø´Ø¯ÙŠÙ†</option>
    <option value="COMPANION">Ù…Ø±Ø§ÙÙ‚ÙŠÙ†</option>
    <option value="DRIVER">Ø³Ø§Ø¦Ù‚ÙŠÙ†</option>
  </select>

  <input type="text" id="assistantSearch" class="filter-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø£Ùˆ Ø§Ù„ØªØ®ØµØµ..." onkeyup="window.filterAssistants()">
  <div id="assistantCardsGrid" class="cards-grid"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDpVqFWJfB4rA2-NA4QIl1w07e2LFQaYic",
  authDomain: "tourguideapp-313c1.firebaseapp.com",
  databaseURL: "https://tourguideapp-313c1-default-rtdb.firebaseio.com",
  projectId: "tourguideapp-313c1",
  storageBucket: "tourguideapp-313c1.appspot.com",
  messagingSenderId: "1036127588385",
  appId: "1:1036127588385:web:d144dba8f70fe094395360"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const roleSelect = document.getElementById('roleSelect');
const grid = document.getElementById('assistantCardsGrid');
const notificationBox = document.getElementById('notificationBox');

const ROLES = { GUIDE:'assistants_guides', COMPANION:'assistants_companions', DRIVER:'assistants_drivers' };
let currentRoleKey = '';
let allAssistants = [];

roleSelect.addEventListener('change', () => {
  currentRoleKey = roleSelect.value;
  loadAndRenderAssistants(currentRoleKey);
});

function renderStars(rating){ return 'â­'.repeat(rating)+'â˜†'.repeat(5-rating); }

function renderCards(list) {
  grid.innerHTML='';
  if(list.length===0){ grid.innerHTML='<p style="text-align:center;color:#aaa;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¹Ø¯ÙˆÙ† Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±.</p>'; return; }

  list.forEach(a=>{
    const card = document.createElement('div');
    card.className='assistant-card';
    card.innerHTML=`
      <div class="card-header">
        <img src="${a.img||'images/placeholder_profile.png'}" class="profile-img" alt="${a.name}">
        <div>
          <h3>${a.name}</h3>
          <div class="rating">${renderStars(5)} (${a.experience || 0} Ø³Ù†ÙˆØ§Øª)</div>
        </div>
      </div>
      <div class="card-details">
        <p><strong>Ù†Ø¨Ø°Ø©:</strong> ${a.about||''}</p>
      </div>
      <button class="btn-delete" onclick="window.deleteAssistant('${currentRoleKey}','${a.appId}')">Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</button>
    `;
    grid.appendChild(card);
  });
}

// Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ†
async function loadAndRenderAssistants(roleKey){
  grid.innerHTML='<p style="text-align:center;color:#ccc;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>';
  if(!roleKey){ grid.innerHTML=''; return; }

  try{
    const snapshot = await get(ref(db, ROLES[roleKey]));
    const data = snapshot.val() ? Object.values(snapshot.val()) : [];

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯
    const prevIds = allAssistants.map(a=>a.appId);
    const newAssistants = data.filter(a=>!prevIds.includes(a.appId));
    if(newAssistants.length>0){
      notificationBox.style.display='block';
      notificationBox.innerHTML=`${newAssistants.length} Ù…Ø³Ø§Ø¹Ø¯ Ø¬Ø¯ÙŠØ¯: ${newAssistants.map(a=>a.name).join(', ')}`;
      setTimeout(()=>{ notificationBox.style.display='none'; }, 5000);
    }

    allAssistants = data;
    renderCards(allAssistants);

  } catch(err){
    console.error(err);
    grid.innerHTML='<p style="text-align:center;color:var(--red-emergency);">ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.</p>';
  }
}

// Ø­Ø°Ù Ù…Ø³Ø§Ø¹Ø¯
window.deleteAssistant = async function(roleKey, appId){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ØŸ')) return;
  try{
    await remove(ref(db, `${ROLES[roleKey]}/${appId}`));
    allAssistants = allAssistants.filter(a=>a.appId!==appId);
    renderCards(allAssistants);
  } catch(err){
    alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯: ' + err.message);
  }
}

// ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ†
window.filterAssistants = function(){
  const term = document.getElementById('assistantSearch').value.toLowerCase();
  const filtered = allAssistants.filter(a=> (a.name||'').toLowerCase().includes(term));
  renderCards(filtered);
}
</script>
</body>
</html>
