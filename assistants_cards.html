<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³Ø§Ø¹Ø¯ Ø³ÙŠØ§Ø­ÙŠ</title>
<style>
:root {
    --dark-bg: #121212;
    --card-bg: #1f1f1f;
    --gold: #ffc107;
    --blue-royal: #4a6fa5;
    --white: #e0e0e0;
    --border-color: #333333;
    --red-emergency: #cf6679;
    --green-success: #4caf50;
    --yellow-warning: #ffeb3b;
    --text-color: #e0e0e0;
}
body {background-color: var(--dark-bg); color: var(--text-color); font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; direction:rtl;}
.header-controls {display:flex; justify-content:flex-end; padding:15px; background-color:#1f1f1f; border-bottom:1px solid var(--border-color);}
.btn-back {background-color:var(--blue-royal); color:#fff; padding:8px 15px; border-radius:6px; text-decoration:none; font-size:0.9em; transition:background-color 0.3s; border:none; cursor:pointer; margin-left:10px;}
.btn-back:hover {background-color:#3b5b82;}
.cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; margin-top: 30px; }
.assistant-card { background-color: #2a2a2a; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); border:1px solid var(--blue-royal); position: relative; transition: transform 0.3s,border-color 0.3s; }
.assistant-card:hover { transform: translateY(-5px); border-color: var(--gold); }
.card-header { display:flex; align-items:center; margin-bottom:15px; border-bottom:1px dashed #444; padding-bottom:10px; }
.profile-img { width:70px; height:70px; border-radius:50%; object-fit:cover; border:2px solid var(--gold); margin-left:15px; }
.card-header h3 { color:var(--gold); margin:0; font-size:1.4em; }
.card-details p { margin:8px 0; text-align:right; font-size:0.95em; color:#ccc; }
.card-details strong { color:var(--white); }
.rating { color: var(--yellow-warning); font-size:1.1em; margin-top:5px; line-height:1.2em; }
.contact-btn, .comments-btn { background-color:var(--green-success); color:var(--dark-bg); padding:10px; width:100%; border:none; border-radius:6px; font-weight:bold; margin-top:10px; cursor:pointer; transition: background-color 0.3s; }
.contact-btn:hover, .comments-btn:hover { background-color:#388e3c; }
.role-title { text-align:center; color:var(--white); background-color:var(--blue-royal); padding:10px; border-radius:8px; margin-bottom:20px; }
.comment-section { display:none; background-color:#1f1f1f; padding:10px; border-radius:6px; margin-top:10px; max-height:300px; overflow-y:auto; }
.comment-item { margin-bottom:8px; line-height:1.3em; padding-bottom:5px; border-bottom:1px dashed #444; }
.comment-name { font-weight:bold; color:var(--gold); display:block; margin-bottom:2px; }
.comment-stars { display:block; color:var(--yellow-warning); margin-bottom:2px; }
.comment-text { display:block; color:#ccc; text-align:right; }
.comment-input, .rating-select { width:100%; padding:6px; margin-top:5px; border-radius:4px; border:1px solid var(--blue-royal); background-color:#2a2a2a; color:#fff; }
.comment-submit { margin-top:5px; padding:6px 12px; border:none; border-radius:6px; background-color:var(--blue-royal); color:#fff; cursor:pointer; }
.comment-submit:hover { background-color:#3b5b82; }
</style>
</head>
<body>
<div class="header-controls">
    <a href="main_services.html" class="btn-back">ğŸ”™ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
</div>
<div class="container" style="max-width:1000px;">
    <h1 id="pageHeading">Ø§Ù‡Ù„Ø§ Ø¨Ùƒ ÙŠØ§ Ø²Ø§Ø¦Ø±Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²</h1>
    <div class="role-title" id="roleTitleDisplay">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†</div>
    <div id="assistantCardsGrid" class="cards-grid"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, get, push, set, child, onValue } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDpVqFWJfB4rA2-NA4QIl1w07e2LFQaYic",
  authDomain: "tourguideapp-313c1.firebaseapp.com",
  databaseURL: "https://tourguideapp-313c1-default-rtdb.firebaseio.com",
  projectId: "tourguideapp-313c1",
  storageBucket: "tourguideapp-313c1.appspot.com",
  messagingSenderId: "1036127588385",
  appId: "1:1036127588385:web:d144dba8f70fe094395360"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ROLES = {
    GUIDE: {key:"GUIDE", name:"Ù…Ø±Ø´Ø¯ Ø³ÙŠØ§Ø­ÙŠ"},
    COMPANION: {key:"COMPANION", name:"Ù…Ø±Ø§ÙÙ‚ Ù„Ø°ÙˆÙŠ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ©"},
    DRIVER: {key:"DRIVER", name:"Ø³Ø§Ø¦Ù‚ Ù†Ù‚Ù„ Ø®Ø§Øµ"}
};

function renderStars(rating){
    let stars='';
    for(let i=1;i<=5;i++) stars+=i<=rating?'â­':'â˜†';
    return stars;
}

function getMajorityRating(comments){
    if(!comments || comments.length===0) return 5;
    const counts={};
    comments.forEach(c=>counts[c.rating]=(counts[c.rating]||0)+1);
    let max=0, majority=5;
    for(const r in counts){ if(counts[r]>max){ max=counts[r]; majority=parseInt(r); } }
    return majority;
}

const urlParams = new URLSearchParams(window.location.search);
const roleKey = urlParams.get('role');

const keyMap = { GUIDE:'assistants_guides', COMPANION:'assistants_companions', DRIVER:'assistants_drivers' };

function loadComments(code){
    const div=document.querySelector(`#comments-${code} .comments-list`);
    div.innerHTML='';
    const commentsRef = ref(db, `assistantComments/${code}`);
    onValue(commentsRef, snapshot => {
        div.innerHTML='';
        snapshot.forEach(snap=>{
            const c = snap.val();
            const el=document.createElement('div');
            el.className='comment-item';
            el.innerHTML=`<span class="comment-name">${c.name||'Ø²Ø§Ø¦Ø±'}</span><span class="comment-stars">${'â­'.repeat(c.rating)}</span><span class="comment-text">${c.text}</span>`;
            div.appendChild(el);
        });
    });
}

// Ø¹Ù†Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ù…Ù† Firebase
async function renderCards(snapshot, roleTitle){
    const grid = document.getElementById('assistantCardsGrid');
    grid.innerHTML='';
    document.getElementById('roleTitleDisplay').textContent = roleTitle;

    if(!snapshot.exists()){
        grid.innerHTML='<p style="text-align:center;color:#aaa;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¹Ø¯ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±.</p>';
        return;
    }

    Object.entries(snapshot.val()).forEach(([appId, a])=>{
        // appId Ù‡Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­ØŒ ÙˆØ¨Ø§Ù„ØªØ§Ù„ÙŠ Ù‡Ùˆ chatCode
        const card = document.createElement('div');
        card.className='assistant-card';
        card.setAttribute('data-id', appId);

        card.innerHTML=`
            <div class="card-header">
                <img src="${a.img||'images/placeholder_profile.png'}" class="profile-img" alt="${a.name}">
                <div>
                    <h3>${a.name}</h3>
                    <div class="rating">${renderStars(getMajorityRating(a.comments))}</div>
                    <div>(${a.experience || 0} Ø³Ù†ÙˆØ§Øª Ø®Ø¨Ø±Ø©)</div>
                </div>
            </div>
            <div class="card-details"><p><strong>Ù†Ø¨Ø°Ø©:</strong> ${a.about}</p></div>
            <button class="contact-btn" onclick="startChat('${appId}','${a.name}')">ğŸ’¬ ØªÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù†</button>
            <button class="comments-btn" onclick="toggleComments('${appId}')">ğŸ’¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</button>
            <div class="comment-section" id="comments-${appId}">
                <div class="comments-list"></div>
                <input type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ..." class="comment-input" id="comment-name-${appId}">
                <input type="text" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹..." class="comment-input" id="comment-input-${appId}">
                <select class="rating-select" id="comment-rating-${appId}">
                    <option value="1">â­ 1</option>
                    <option value="2">â­ 2</option>
                    <option value="3">â­ 3</option>
                    <option value="4">â­ 4</option>
                    <option value="5" selected>â­ 5</option>
                </select>
                <button class="comment-submit" onclick="submitComment('${appId}')">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</button>
            </div>
        `;
        grid.appendChild(card);
        loadComments(appId);
    });
}
}

function submitComment(code){
    const nameInput=document.getElementById(`comment-name-${code}`);
    const textInput=document.getElementById(`comment-input-${code}`);
    const ratingSelect=document.getElementById(`comment-rating-${code}`);
    const name=nameInput.value.trim()||"Ø²Ø§Ø¦Ø±";
    const text=textInput.value.trim();
    const rating=parseInt(ratingSelect.value);
    if(!text) return;
    const newCommentRef = push(ref(db, `assistantComments/${code}`));
    set(newCommentRef, {name,text,rating});
    nameInput.value=''; textInput.value=''; ratingSelect.value='5';
}

function toggleComments(code){ const sec=document.getElementById(`comments-${code}`); sec.style.display=sec.style.display==='block'?'none':'block'; }

function startChat(code,name){ window.location.href=`chat_page.html?code=${code}&name=${encodeURIComponent(name)}`; }

async function renderCards(assistantsList,title){
    document.getElementById('roleTitleDisplay').textContent = title;
    const grid = document.getElementById('assistantCardsGrid');
    grid.innerHTML='';
    if(assistantsList.length===0){ grid.innerHTML='<p style="text-align:center;color:#aaa;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¹Ø¯ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±.</p>'; return; }
    assistantsList.forEach(a=>{
        const card = document.createElement('div');
        card.className='assistant-card';
        card.setAttribute('data-id', a.chatCode);
        let details='';
        if(a.groupLimit){ details+=`<p><strong>Ø§Ù„ØªØ®ØµØµ:</strong> ${a.guideType||'Ø¹Ø§Ù…'}</p>`; details+=`<p><strong>Ø­Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</strong> ${a.groupLimit} Ø´Ø®Øµ</p>`; details+=`<p><strong>Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…:</strong> ${a.price} Ø¯Ø±Ù‡Ù…</p>`; }
        else if(a.specialization){ details+=`<p><strong>Ø§Ù„ØªØ®ØµØµ:</strong> ${a.specialization}</p>`; details+=`<p><strong>Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…:</strong> ${a.priceDay} Ø¯Ø±Ù‡Ù…</p>`; details+=`<p><strong>Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©:</strong> ${a.priceHour} Ø¯Ø±Ù‡Ù…</p>`; }
        else if(a.cityPrice){ details+=`<p><strong>Ø£Ø¬Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${a.cityPrice} Ø¯Ø±Ù‡Ù…</p>`; details+=`<p><strong>Ø£Ø¬Ø±Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${a.outCityPrice} Ø¯Ø±Ù‡Ù…</p>`; }

        card.innerHTML=`
            <div class="card-header">
                <img src="${a.img||'images/placeholder_profile.png'}" class="profile-img" alt="${a.name}">
                <div>
                    <h3>${a.name}</h3>
                    <div class="rating">${renderStars(getMajorityRating(a.comments))}</div>
                    <div>(${a.experience} Ø³Ù†ÙˆØ§Øª Ø®Ø¨Ø±Ø©)</div>
                </div>
            </div>
            <div class="card-details">${details}<p><strong>Ù†Ø¨Ø°Ø©:</strong> ${a.about}</p></div>
            <button class="contact-btn" onclick="startChat('${a.chatCode}','')">ğŸ’¬ ØªÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù†</button>
            <button class="comments-btn" onclick="toggleComments('${a.chatCode}')">ğŸ’¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</button>
            <div class="comment-section" id="comments-${a.chatCode}">
                <div class="comments-list"></div>
                <input type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ..." class="comment-input" id="comment-name-${a.chatCode}">
                <input type="text" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹..." class="comment-input" id="comment-input-${a.chatCode}">
                <select class="rating-select" id="comment-rating-${a.chatCode}">
                    <option value="1">â­ 1</option>
                    <option value="2">â­ 2</option>
                    <option value="3">â­ 3</option>
                    <option value="4">â­ 4</option>
                    <option value="5" selected>â­ 5</option>
                </select>
                <button class="comment-submit" onclick="submitComment('${a.chatCode}')">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</button>
            </div>
        `;
        grid.appendChild(card);
        loadComments(a.chatCode);
    });
}

document.addEventListener('DOMContentLoaded', async () => {
    if(roleKey){
        const snapshot = await get(ref(db,keyMap[roleKey]));
        renderCards(snapshot.exists()?Object.values(snapshot.val()):[],ROLES[roleKey].name);
    } else {
        const guides = (await get(ref(db,'assistants_guides'))).val() || {};
        const companions = (await get(ref(db,'assistants_companions'))).val() || {};
        const drivers = (await get(ref(db,'assistants_drivers'))).val() || {};
        renderCards([...Object.values(guides),...Object.values(companions),...Object.values(drivers)],"Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ†");
    }
});
</script>
</body>
</html>
