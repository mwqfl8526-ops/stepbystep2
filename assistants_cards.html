<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ø§Ù„Ø³ÙŠØ§Ø­ÙŠÙŠÙ†</title>
<style>
:root {
  --dark-bg:#121212; --card-bg:#1f1f1f; --gold:#ffc107;
  --blue-royal:#4a6fa5; --white:#e0e0e0; --border-color:#333;
}
body {background-color:var(--dark-bg); color:var(--white); font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; direction:rtl;}
.header {display:flex; justify-content:space-between; padding:15px; background:#1f1f1f; border-bottom:1px solid var(--border-color);}
.header h1 {margin:0;}
.filter-container {padding:10px 20px; background:#222; display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
.filter-container label {margin-right:5px;}
.filter-container select {padding:5px 10px; border-radius:5px; border:none; background:#333; color:#fff;}
.cards-grid {display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; padding:20px;}
.assistant-card {background:var(--card-bg); border-radius:10px; padding:20px; border:1px solid var(--blue-royal);}
.rating {color:var(--gold);}
button.contact-btn {padding:10px; width:100%; border:none; border-radius:5px; margin-top:10px; cursor:pointer; background:var(--blue-royal); color:#fff;}
#loader {display:none;text-align:center;padding:50px;font-size:1.2em;color:#ccc;}
#noDataMsg {display:none;text-align:center;padding:50px;font-size:1.2em;color:#aaa;}
</style>
</head>
<body>

<div class="header">
  <h1 id="pageTitle">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø­ÙŠÙˆÙ†</h1>
  <a href="index.html" style="color:white;text-decoration:none;">ğŸ”™ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
</div>

<div class="filter-container">
  <label for="ratingFilter">ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
  <select id="ratingFilter">
    <option value="0">Ø§Ù„ÙƒÙ„</option>
    <option value="1">1â­ ÙÙ…Ø§ ÙÙˆÙ‚</option>
    <option value="2">2â­ ÙÙ…Ø§ ÙÙˆÙ‚</option>
    <option value="3">3â­ ÙÙ…Ø§ ÙÙˆÙ‚</option>
    <option value="4">4â­ ÙÙ…Ø§ ÙÙˆÙ‚</option>
    <option value="5">5â­ ÙÙ‚Ø·</option>
  </select>

  <label for="typeFilter">ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„ØªØ®ØµØµ:</label>
  <select id="typeFilter">
    <option value="all">Ø§Ù„ÙƒÙ„</option>
    <option value="Ø¯ÙŠÙ†ÙŠ">Ø¯ÙŠÙ†ÙŠ</option>
    <option value="ØªØ±ÙÙŠÙ‡ÙŠ">ØªØ±ÙÙŠÙ‡ÙŠ</option>
    <option value="Ø«Ù‚Ø§ÙÙŠ">Ø«Ù‚Ø§ÙÙŠ</option>
    <option value="ØªØ¬Ø§Ø±ÙŠ">ØªØ¬Ø§Ø±ÙŠ</option>
  </select>
</div>

<div id="loader">... Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
<div id="noDataMsg">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>
<div id="assistantCardsGrid" class="cards-grid"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDpVqFWJfB4rA2-NA4QIl1w07e2LFQaYic",
  authDomain: "tourguideapp-313c1.firebaseapp.com",
  databaseURL: "https://tourguideapp-313c1-default-rtdb.firebaseio.com",
  projectId: "tourguideapp-313c1",
  storageBucket: "tourguideapp-313c1.appspot.com",
  messagingSenderId: "1036127588385",
  appId: "1:1036127588385:web:d144dba8f70fe094395360"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const ROLES = {
  GUIDE: {key:"GUIDE", name:"Ù…Ø±Ø´Ø¯ Ø³ÙŠØ§Ø­ÙŠ", dbKey:'assistants_guides'},
  COMPANION: {key:"COMPANION", name:"Ù…Ø±Ø§ÙÙ‚ Ù„Ø°ÙˆÙŠ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ø®Ø§ØµØ©", dbKey:'assistants_companions'},
  DRIVER: {key:"DRIVER", name:"Ø³Ø§Ø¦Ù‚ Ù†Ù‚Ù„ Ø®Ø§Øµ", dbKey:'assistants_drivers'}
};

function renderStars(r){return 'â­'.repeat(r)+'â˜†'.repeat(5-r);}
function getMajorityRating(comments){if(!comments||comments.length===0)return 5; const counts={}; comments.forEach(c=>counts[c.rating]=(counts[c.rating]||0)+1); let max=0,majority=5; for(const r in counts){if(counts[r]>max){max=counts[r]; majority=parseInt(r);}} return majority;}

async function fetchAssistants(roleKey){
  document.getElementById('loader').style.display='block';
  document.getElementById('noDataMsg').style.display='none';
  const localKey = roleKey ? `assistants_${roleKey}` : 'assistants_all';
  if(localStorage.getItem(localKey)){
    document.getElementById('loader').style.display='none';
    return JSON.parse(localStorage.getItem(localKey));
  }
  const dbRefs = roleKey ? [ref(db,ROLES[roleKey].dbKey)] : [ref(db,'assistants_guides'), ref(db,'assistants_companions'), ref(db,'assistants_drivers')];
  let allData = [];
  for(const r of dbRefs){
    const snap = await get(r);
    if(snap.exists()) allData.push(...Object.values(snap.val()));
  }
  localStorage.setItem(localKey,JSON.stringify(allData));
  document.getElementById('loader').style.display='none';
  return allData;
}

async function displayAssistants(roleKey,minRating=0,typeFilter='all'){
  const grid = document.getElementById('assistantCardsGrid');
  grid.innerHTML='';
  let allData = await fetchAssistants(roleKey);
  let filteredData = allData.filter(a=>{
    const comments = JSON.parse(localStorage.getItem(`comments_${a.appId}`))||[];
    const rating = getMajorityRating(comments);
    if(rating<minRating) return false;
    if(typeFilter!=='all' && a.type!==typeFilter) return false;
    return true;
  });
  if(filteredData.length===0){
    document.getElementById('noDataMsg').style.display='block';
    return;
  } else {
    document.getElementById('noDataMsg').style.display='none';
  }
  filteredData.forEach(a=>{
    const comments = JSON.parse(localStorage.getItem(`comments_${a.appId}`))||[];
    const rating = getMajorityRating(comments);
    const card = document.createElement('div'); card.className='assistant-card';
    let details='';
    if(a.groupLimit){ details+=`<p>Ø§Ù„ØªØ®ØµØµ: ${a.guideType||'Ø¹Ø§Ù…'}</p><p>Ø­Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${a.groupLimit}</p><p>Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…: ${a.price} Ø¯Ø±Ù‡Ù…</p>`;}
    else if(a.specialization){ details+=`<p>Ø§Ù„ØªØ®ØµØµ: ${a.specialization}</p><p>Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…: ${a.priceDay}</p><p>Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø©: ${a.priceHour}</p>`;}
    else if(a.cityPrice){ details+=`<p>Ø£Ø¬Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${a.cityPrice}</p><p>Ø£Ø¬Ø±Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${a.outCityPrice}</p>`;}
    card.innerHTML=`<h3>${a.name}</h3>${details}<p class="rating">${renderStars(rating)}</p>
    <button class="contact-btn" onclick="startChat('${a.appId}','${a.name}')">ğŸ’¬ ØªÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù†</button>`;
    grid.appendChild(card);
  });
}

function startChat(code,name){window.location.href=`chat_page?code=${code}`;}

document.getElementById('ratingFilter').addEventListener('change',async(e)=>{
  const minRating=parseInt(e.target.value);
  const typeFilter=document.getElementById('typeFilter').value;
  const roleKey=new URLSearchParams(window.location.search).get('role');
  await displayAssistants(roleKey,minRating,typeFilter);
});

document.getElementById('typeFilter').addEventListener('change',async(e)=>{
  const typeFilter=e.target.value;
  const minRating=parseInt(document.getElementById('ratingFilter').value);
  const roleKey=new URLSearchParams(window.location.search).get('role');
  await displayAssistants(roleKey,minRating,typeFilter);
});

document.addEventListener('DOMContentLoaded',async()=>{
  const roleKey=new URLSearchParams(window.location.search).get('role');
  await displayAssistants(roleKey);
});
</script>
</body>
</html>
