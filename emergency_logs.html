<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        body { background-color:#1e1e2f; color:#fff; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; }
        .container { max-width:1200px; margin:auto; padding:20px; }
        h1 { text-align:center; margin-bottom:20px; }
        .header-controls { display:flex; justify-content:center; gap:15px; margin-bottom:20px; flex-wrap:wrap; }
        .btn-back, .btn-primary { padding:10px 15px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
        .btn-back { background-color:#555; color:#fff; }
        .btn-primary { background-color:#4169e1; color:#fff; }
        .requests-table-container { overflow-x:auto; margin-top:20px; }
        .requests-table { width:100%; border-collapse:collapse; margin-top:15px; }
        .requests-table th, .requests-table td { border:1px solid #444; padding:12px 10px; text-align:right; }
        .requests-table th { background-color:#4169e1; color:#fff; font-weight:bold; }
        .requests-table tr:nth-child(even) { background-color:#2a2a2a; }
        .requests-table tr:hover { background-color:#333; }
    </style>
</head>
<body>
    <div class="header-controls">
        <a href="manager_dashboard.html" class="btn-back">ğŸ”™ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</a>
    </div>

    <div class="container">
        <h1>Ø³Ø¬Ù„ Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ğŸš¨</h1>
        <p>Ù‡Ù†Ø§ ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ§Ø­ Ù…Ø¹ Ø§Ù„Ø§Ø³Ù…ØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.</p>
        <button onclick="displayEmergencyLogs()" class="btn-primary" style="margin-top:15px;">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„</button>
        <button onclick="confirmDeleteAllLogs()" class="btn-back" style="background-color:#ff4d4d;">ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>

        <div class="requests-table-container">
            <table class="requests-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                        <th>ÙˆÙ‚Øª Ø§Ù„Ø¨Ù„Ø§Øº</th>
                        <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="emergencyTableBody"></tbody>
            </table>
        </div>
        <p id="noLogsMessage" style="text-align:center; color:gold; margin-top:50px; display:none;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ø·ÙˆØ§Ø±Ø¦ Ø¬Ø¯ÙŠØ¯Ø©.</p>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDpVqFWJfB4rA2-NA4QIl1w07e2LFQaYic",
          authDomain: "tourguideapp-313c1.firebaseapp.com",
          databaseURL: "https://tourguideapp-313c1-default-rtdb.firebaseio.com",
          projectId: "tourguideapp-313c1",
          storageBucket: "tourguideapp-313c1.firebasestorage.app",
          messagingSenderId: "1036127588385",
          appId: "1:1036127588385:web:d144dba8f70fe094395360"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function displayEmergencyLogs() {
            const tbody = document.getElementById('emergencyTableBody');
            const noLogsMessage = document.getElementById('noLogsMessage');
            tbody.innerHTML = '';

            db.ref('emergencies').once('value').then(snapshot=>{
                const logs = snapshot.val();
                if(!logs){ noLogsMessage.style.display='block'; return; }
                noLogsMessage.style.display='none';
                Object.values(logs).forEach(log=>{
                    const tr = document.createElement('tr');
                    let locationCell = log.location && log.location.gMapsURL
                        ? `<a href="${log.location.gMapsURL}" target="_blank" class="btn-primary" style="background-color:#ff4d4d;">ğŸ”´ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­ÙŠ</a><br><small>(${log.location.lat}, ${log.location.lng})</small>`
                        : log.location || "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
                    tr.innerHTML=`
                        <td>${log.id}</td>
                        <td>${log.name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}</td>
                        <td>${log.phone || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</td>
                        <td>${log.time}</td>
                        <td>${locationCell}</td>
                        <td><button onclick="removeLog('${log.id}')" class="btn-back" style="background-color:#8c1a1a;">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        function removeLog(id) {
            if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¨Ù„Ø§Øº Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø±Ù‚Ù… ${id}ØŸ`)){
                db.ref('emergencies/' + id).remove()
                  .then(()=> { alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­.'); displayEmergencyLogs(); })
                  .catch(err=> { alert('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº.'); console.error(err); });
            }
        }

        function confirmDeleteAllLogs() {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")){
                db.ref('emergencies').remove()
                  .then(()=> { displayEmergencyLogs(); alert("âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø¨Ù†Ø¬Ø§Ø­."); })
                  .catch(err=> { console.error(err); });
            }
        }

        document.addEventListener('DOMContentLoaded', displayEmergencyLogs);
    </script>
</body>
</html>